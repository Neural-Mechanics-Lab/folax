import pytest
import unittest 
import os,sys
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..','..')))
import numpy as np
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss2DQuad
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss3DTetra
from fol.loss_functions.mechanical_neohooke import NeoHookeMechanicalLoss3DHexa
from fol.tools.usefull_functions import *

class TestMechanical3D(unittest.TestCase):

    @pytest.fixture(autouse=True)
    def _request_debug_mode(self,request):
        self.debug_mode = request.config.getoption('--debug-mode')

    def test_tetra(self):

        tet_points_coordinates = jnp.array([[0.1, 0.1, 0.1],
                                            [0.28739360416666665, 0.27808503701741405, 0.05672979583333333],
                                            [0.0, 1.0, 0.0],
                                            [0.0, 1.0, 0.1]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(tet_points_coordinates))
        fe_mesh.nodes_coordinates = tet_points_coordinates
        fe_mesh.elements_nodes = {"tetra":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DTetra("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                                       "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                                                       "body_foce":jnp.array([[1],[2],[3]])},
                                                                                        fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()
        
        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(tet_points_coordinates,
                                                                        jnp.ones((4)),
                                                                        jnp.ones((12,1)))

        test = np.testing.assert_allclose(stiffness,jnp.array([[6.554752588272094727e-02,1.783142797648906708e-02,-1.990727582779072691e-09,-7.916515320539474487e-02,-1.261477451771497726e-02,2.082763073119053843e-09,3.425490111112594604e-02,5.458424333482980728e-03,6.941492110490798950e-02,-2.063727192580699921e-02,-1.067507825791835785e-02,-6.941492855548858643e-02],
                                                        [1.783142983913421631e-02,2.785473130643367767e-02,-7.925068379321942302e-10,-1.581991091370582581e-02,-2.579434774816036224e-02,8.291455300124539463e-10,6.845297291874885559e-03,1.116125937551259995e-02,2.763399481773376465e-02,-8.856814354658126831e-03,-1.322163920849561691e-02,-2.763399481773376465e-02],
                                                        [-1.990727804823677616e-09,-7.925066713987405365e-10,2.075605653226375580e-02,2.555405442805636085e-09,3.050550090311077156e-10,-2.332433313131332397e-02,4.627655819058418274e-02,1.842264458537101746e-02,1.009248010814189911e-02,-4.627655819058418274e-02,-1.842264458537101746e-02,-7.524203509092330933e-03],
                                                        [-7.916515320539474487e-02,-1.581991091370582581e-02,2.555406108939450860e-09,9.780599921941757202e-02,7.735083810985088348e-03,-2.688298694764057473e-09,-4.232082888484001160e-02,-3.346970537677407265e-03,-8.653850108385086060e-02,2.367997914552688599e-02,1.143179833889007568e-02,8.653849363327026367e-02],
                                                        [-1.261477638036012650e-02,-2.579434774816036224e-02,3.050551755645614094e-10,7.735084276646375656e-03,2.904957905411720276e-02,-2.986996205933678539e-10,-3.346977988258004189e-03,-1.256980840116739273e-02,-9.615369141101837158e-03,8.226669393479824066e-03,9.314575232565402985e-03,9.615369141101837158e-03],
                                                        [2.082762406985239068e-09,8.291456965459076400e-10,-2.332433313131332397e-02,-2.688298694764057473e-09,-2.986997316156703164e-10,2.819012850522994995e-02,-5.769225582480430603e-02,-6.410243455320596695e-03,-1.219791825860738754e-02,5.769225582480430603e-02,6.410242523998022079e-03,7.332123816013336182e-03],
                                                        [3.425490483641624451e-02,6.845297291874885559e-03,4.627655446529388428e-02,-4.232083261013031006e-02,-3.346977755427360535e-03,-5.769225582480430603e-02,1.378396302461624146e-01,1.448237337172031403e-03,6.240888684988021851e-02,-1.297736912965774536e-01,-4.946555942296981812e-03,-5.099318921566009521e-02],
                                                        [5.458424333482980728e-03,1.116125937551259995e-02,1.842264458537101746e-02,-3.346970537677407265e-03,-1.256980840116739273e-02,-6.410243920981884003e-03,1.448237220756709576e-03,1.249663084745407104e-01,6.934270728379487991e-03,-3.559691132977604866e-03,-1.235577613115310669e-01,-1.894667185842990875e-02],
                                                        [6.941492110490798950e-02,2.763399668037891388e-02,1.009248010814189911e-02,-8.653848618268966675e-02,-9.615370072424411774e-03,-1.219791918992996216e-02,6.240888684988021851e-02,6.934270728379487991e-03,4.236239194869995117e-01,-4.528531059622764587e-02,-2.495289780199527740e-02,-4.215185046195983887e-01],
                                                        [-2.063727192580699921e-02,-8.856814354658126831e-03,-4.627655819058418274e-02,2.367998100817203522e-02,8.226669393479824066e-03,5.769225582480430603e-02,-1.297736912965774536e-01,-3.559691132977604866e-03,-4.528531432151794434e-02,1.267309933900833130e-01,4.189835395663976669e-03,3.386961296200752258e-02],
                                                        [-1.067507732659578323e-02,-1.322163920849561691e-02,-1.842264644801616669e-02,1.143179833889007568e-02,9.314575232565402985e-03,6.410243455320596695e-03,-4.946556873619556427e-03,-1.235577762126922607e-01,-2.495289780199527740e-02,4.189835395663976669e-03,1.274648308753967285e-01,3.696529567241668701e-02],
                                                        [-6.941492855548858643e-02,-2.763399668037891388e-02,-7.524203509092330933e-03,8.653849363327026367e-02,9.615370072424411774e-03,7.332124747335910797e-03,-5.099318921566009521e-02,-1.894667185842990875e-02,-4.215185046195983887e-01,3.386961296200752258e-02,3.696530312299728394e-02,4.217106103897094727e-01]])
                                    ,rtol=1e-6, atol=1e-8)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([-7.769310614094138145e-04,
                                                                    -1.553858397528529167e-03,
                                                                    -2.330785151571035385e-03,
                                                                    -7.769249496050179005e-04,
                                                                    -1.553854555822908878e-03,
                                                                    -2.330783754587173462e-03,
                                                                    -7.769309449940919876e-04,
                                                                    -1.553858513943850994e-03,
                                                                    -2.330788411200046539e-03,
                                                                    -7.769256480969488621e-04,
                                                                    -1.553853740915656090e-03,
                                                                    -2.330780494958162308e-03])
                                   ,rtol=1e-6, atol=1e-10)

    def test_hexa(self):
        hex_points_coordinates = jnp.array([[0.24900,  0.34200,  0.19200],
                                            [0.32000,  0.18600,  0.64300],
                                            [0.16500,  0.74500,  0.70200],
                                            [0.27300,  0.75000,  0.23000],
                                            [0.00000,  0.00000,  0.00000],
                                            [0.00000,  0.00000,  1.00000],
                                            [0.00000,  1.00000,  1.00000],
                                            [0.00000,  1.00000,  0.00000]])

        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(hex_points_coordinates))
        fe_mesh.nodes_coordinates = hex_points_coordinates
        fe_mesh.elements_nodes = {"hexahedron":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss3DHexa("mechanical_loss_3d",loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                  "material_dict":{"young_modulus":1,"poisson_ratio":0.3},
                                                  "body_foce":jnp.array([[1],[2],[3]])},
                                                   fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(hex_points_coordinates,
                                                                        jnp.ones((8)),
                                                                        jnp.ones((24,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[4.549593627452850342e-01,-5.003670603036880493e-02,-6.413353979587554932e-02,1.073997467756271362e-01,-1.725477166473865509e-02,1.959061773959547281e-05,3.525663865730166435e-03,-2.807064214721322060e-03,-1.108624972403049469e-03,9.766512364149093628e-02,1.389564201235771179e-02,-1.016072742640972137e-02,-2.731851637363433838e-01,-2.359371632337570190e-02,-1.519866660237312317e-02,-1.242664977908134460e-01,-7.150741294026374817e-03,6.020548194646835327e-02,-7.600149512290954590e-02,2.662716805934906006e-02,3.016667254269123077e-02,-1.900967359542846680e-01,6.032019108533859253e-02,2.098207041854038835e-04],
                                                        [-5.003670230507850647e-02,1.730976253747940063e-01,2.268390543758869171e-02,-1.834451034665107727e-02,3.667685389518737793e-02,-2.939358353614807129e-03,-9.425650350749492645e-03,-2.148867025971412659e-02,-2.364687621593475342e-02,-7.658826652914285660e-03,-4.841258283704519272e-03,-2.952247858047485352e-03,-9.495166013948619366e-04,-5.550459399819374084e-02,1.176930125802755356e-02,3.153733909130096436e-03,-3.028255701065063477e-02,1.385121257044374943e-03,2.662717364728450775e-02,-2.925663813948631287e-02,-8.546776138246059418e-03,5.663430318236351013e-02,-6.840075552463531494e-02,2.246927237138152122e-03],
                                                        [-6.413353979587554932e-02,2.268390171229839325e-02,1.895466744899749756e-01,-2.393867634236812592e-02,4.079851321876049042e-03,-5.042747128754854202e-03,-1.014707982540130615e-02,-2.440006285905838013e-02,-2.891526557505130768e-02,-1.126649882644414902e-02,-1.072467304766178131e-02,3.354643285274505615e-02,9.865391068160533905e-03,1.252250559628009796e-02,-5.288928002119064331e-02,5.722469463944435120e-02,6.513316184282302856e-03,-5.409054085612297058e-02,3.016666695475578308e-02,-8.546772412955760956e-03,-3.269629552960395813e-02,1.222904026508331299e-02,-2.128068823367357254e-03,-4.945899173617362976e-02],
                                                        [1.073997393250465393e-01,-1.834451034665107727e-02,-2.393868193030357361e-02,4.541187286376953125e-01,-3.964756801724433899e-02,5.597997829318046570e-02,1.686107963323593140e-01,1.625897921621799469e-02,2.908254228532314301e-02,2.097911387681961060e-02,8.451564237475395203e-03,-6.522010546177625656e-03,-2.122017741203308105e-01,-1.185737177729606628e-02,-6.271006911993026733e-02,-2.640954554080963135e-01,-3.817569836974143982e-02,2.710846997797489166e-02,-1.567426472902297974e-01,5.383357033133506775e-02,1.069469470530748367e-02,-1.180685088038444519e-01,2.948103472590446472e-02,-2.969492599368095398e-02],
                                                        [-1.725477166473865509e-02,3.667685389518737793e-02,4.079850856214761734e-03,-3.964756801724433899e-02,1.551146060228347778e-01,-1.387120597064495087e-02,-9.029448032379150391e-03,2.212569862604141235e-02,-5.087566561996936798e-03,2.784962998703122139e-04,-1.346016954630613327e-02,1.561301108449697495e-02,1.091327401809394360e-03,-5.500620603561401367e-02,6.139675388112664223e-04,-1.397702097892761230e-02,-5.473996698856353760e-02,-9.584238752722740173e-03,4.905794560909271240e-02,-4.950612410902976990e-02,-6.969177047722041607e-04,2.948103845119476318e-02,-4.120468348264694214e-02,8.933098986744880676e-03],
                                                        [1.959224755410104990e-05,-2.939357887953519821e-03,-5.042743869125843048e-03,5.597997829318046570e-02,-1.387120783329010010e-02,1.629704385995864868e-01,2.760820090770721436e-02,3.277804004028439522e-03,6.186895072460174561e-02,-6.368277536239475012e-05,1.695915684103965759e-02,-8.637193590402603149e-03,-5.722929909825325012e-02,-3.376411739736795425e-03,-7.559854537248611450e-02,4.624535329639911652e-03,-1.093039289116859436e-02,-5.509355291724205017e-02,-1.244394923560321331e-03,1.947310869581997395e-03,-3.777534142136573792e-02,-2.969492040574550629e-02,8.933097124099731445e-03,-4.269202053546905518e-02],
                                                        [3.525664564222097397e-03,-9.425650350749492645e-03,-1.014708075672388077e-02,1.686107814311981201e-01,-9.029446169734001160e-03,2.760820090770721436e-02,7.218261957168579102e-01,1.038958355784416199e-01,9.981564432382583618e-02,1.321056932210922241e-01,2.245614863932132721e-02,-1.631078310310840607e-02,-1.370416134595870972e-01,-3.523723408579826355e-02,-3.611882403492927551e-02,-2.376564294099807739e-01,-7.331799715757369995e-02,-1.052761450409889221e-03,-3.902187645435333252e-01,2.833865350112318993e-03,8.929622359573841095e-03,-2.611514329910278320e-01,-2.175522269681096077e-03,-7.272401452064514160e-02],
                                                        [-2.807063283398747444e-03,-2.148867025971412659e-02,-2.440006472170352936e-02,1.625897735357284546e-02,2.212569862604141235e-02,3.277804469689726830e-03,1.038958355784416199e-01,2.699035108089447021e-01,3.375126793980598450e-02,1.981191895902156830e-02,5.031590536236763000e-02,-1.986228162422776222e-03,-3.523721918463706970e-02,-5.403268709778785706e-02,-1.261047460138797760e-02,-6.759682297706604004e-02,-9.437167644500732422e-02,-4.371747781988233328e-04,-1.981036178767681122e-02,-9.844949096441268921e-02,6.833177991211414337e-03,-1.451526302844285965e-02,-7.400256395339965820e-02,-4.428308922797441483e-03],
                                                        [-1.108625670894980431e-03,-2.364687621593475342e-02,-2.891526557505130768e-02,2.908254228532314301e-02,-5.087566561996936798e-03,6.186895072460174561e-02,9.981564432382583618e-02,3.375126421451568604e-02,2.700506448745727539e-01,7.278967648744583130e-03,7.132357917726039886e-03,1.041517965495586395e-02,-3.611881658434867859e-02,-1.261047739535570145e-02,-5.447864159941673279e-02,-1.409762259572744370e-02,-5.565372295677661896e-03,-6.636006385087966919e-02,-1.613447815179824829e-02,6.079970858991146088e-03,-9.570439159870147705e-02,-6.871760636568069458e-02,-5.330970452632755041e-05,-9.687640517950057983e-02],
                                                        [9.766512364149093628e-02,-7.658825255930423737e-03,-1.126649789512157440e-02,2.097911760210990906e-02,2.784976386465132236e-04,-6.368312460836023092e-05,1.321056932210922241e-01,1.981192082166671753e-02,7.278967648744583130e-03,4.369201064109802246e-01,5.636066570878028870e-02,-3.568708896636962891e-02,-1.591054797172546387e-01,-6.000977009534835815e-02,-1.029070932418107986e-02,-8.198963850736618042e-02,-2.808043919503688812e-02,2.482154779136180878e-02,-1.548487395048141479e-01,2.500936156138777733e-03,5.424158647656440735e-02,-2.917262017726898193e-01,1.679701544344425201e-02,-2.903411537408828735e-02],
                                                        [1.389564387500286102e-02,-4.841258283704519272e-03,-1.072467304766178131e-02,8.451564237475395203e-03,-1.346016954630613327e-02,1.695915684103965759e-02,2.245614863932132721e-02,5.031590536236763000e-02,7.132358849048614502e-03,5.636066943407058716e-02,1.699065119028091431e-01,-1.440778840333223343e-02,-5.693284049630165100e-02,-6.362350285053253174e-02,-3.832591464743018150e-03,-2.808042988181114197e-02,-3.647279366850852966e-02,1.023514755070209503e-02,-8.749058470129966736e-03,-3.971033543348312378e-02,4.482368938624858856e-03,-7.401695940643548965e-03,-6.211435422301292419e-02,-9.843978099524974823e-03],
                                                        [-1.016072649508714676e-02,-2.952247625216841698e-03,3.354643285274505615e-02,-6.522009149193763733e-03,1.561301108449697495e-02,-8.637193590402603149e-03,-1.631077937781810760e-02,-1.986228860914707184e-03,1.041517779231071472e-02,-3.568708896636962891e-02,-1.440778933465480804e-02,1.533560901880264282e-01,2.541565627325326204e-04,1.577912480570375919e-04,-4.160181805491447449e-02,2.482154220342636108e-02,1.023515127599239349e-02,-3.127345070242881775e-02,5.015504732728004456e-02,1.838139491155743599e-03,-5.198257416486740112e-02,-6.550141144543886185e-03,-8.497827686369419098e-03,-6.382265686988830566e-02],
                                                        [-2.731851339340209961e-01,-9.495174745097756386e-04,9.865392930805683136e-03,-2.122017741203308105e-01,1.091326703317463398e-03,-5.722930282354354858e-02,-1.370416134595870972e-01,-3.523721918463706970e-02,-3.611881658434867859e-02,-1.591054797172546387e-01,-5.693284049630165100e-02,2.541558060329407454e-04,2.780420184135437012e-01,6.334275007247924805e-02,6.574562191963195801e-02,1.704120337963104248e-01,4.617323726415634155e-02,-1.650563813745975494e-02,1.295356005430221558e-01,-8.861570619046688080e-03,-9.853960946202278137e-03,2.035443335771560669e-01,-8.626165799796581268e-03,4.384255036711692810e-02],
                                                        [-2.359371632337570190e-02,-5.550459399819374084e-02,1.252250559628009796e-02,-1.185737270861864090e-02,-5.500620603561401367e-02,-3.376411739736795425e-03,-3.523723036050796509e-02,-5.403268709778785706e-02,-1.261047553271055222e-02,-6.000977009534835815e-02,-6.362350285053253174e-02,1.577910734340548515e-04,6.334275007247924805e-02,1.245281770825386047e-01,2.256877161562442780e-02,4.352901130914688110e-02,6.080712750554084778e-02,-3.136842977255582809e-03,7.164059672504663467e-03,1.603598706424236298e-02,-2.014619112014770508e-02,1.666227541863918304e-02,2.679570205509662628e-02,4.020852036774158478e-03],
                                                        [-1.519866846501827240e-02,1.176930125802755356e-02,-5.288928374648094177e-02,-6.271006911993026733e-02,6.139677716419100761e-04,-7.559855282306671143e-02,-3.611882403492927551e-02,-1.261047460138797760e-02,-5.447864159941673279e-02,-1.029070932418107986e-02,-3.832592396065592766e-03,-4.160182178020477295e-02,6.574562191963195801e-02,2.256877161562442780e-02,1.257642507553100586e-01,7.084078155457973480e-03,5.981741473078727722e-03,1.611063815653324127e-02,6.171671207994222641e-03,-2.014619112014770508e-02,1.435151882469654083e-02,4.531690478324890137e-02,-4.344527143985033035e-03,6.834190338850021362e-02],
                                                        [-1.242665052413940430e-01,3.153733676299452782e-03,5.722469463944435120e-02,-2.640954554080963135e-01,-1.397702284157276154e-02,4.624534863978624344e-03,-2.376564294099807739e-01,-6.759682297706604004e-02,-1.409762259572744370e-02,-8.198965340852737427e-02,-2.808042988181114197e-02,2.482154220342636108e-02,1.704120486974716187e-01,4.352901503443717957e-02,7.084077689796686172e-03,2.299356311559677124e-01,6.590872257947921753e-02,-5.111279338598251343e-02,1.696083545684814453e-01,-3.615549998357892036e-03,-3.453864529728889465e-02,1.380520462989807129e-01,6.783563876524567604e-04,5.994204897433519363e-03],
                                                        [-7.150741759687662125e-03,-3.028255701065063477e-02,6.513316184282302856e-03,-3.817569836974143982e-02,-5.473996698856353760e-02,-1.093039289116859436e-02,-7.331799715757369995e-02,-9.437167644500732422e-02,-5.565372295677661896e-03,-2.808043919503688812e-02,-3.647279366850852966e-02,1.023515127599239349e-02,4.617323353886604309e-02,6.080712750554084778e-02,5.981741007417440414e-03,6.590872257947921753e-02,1.156338751316070557e-01,-2.268875762820243835e-02,1.793892309069633484e-02,2.019480802118778229e-02,-3.740938380360603333e-03,1.670398563146591187e-02,1.923118531703948975e-02,2.019525133073329926e-02],
                                                        [6.020547822117805481e-02,1.385121257044374943e-03,-5.409054085612297058e-02,2.710846811532974243e-02,-9.584236890077590942e-03,-5.509354546666145325e-02,-1.052761101163923740e-03,-4.371739050839096308e-04,-6.636005640029907227e-02,2.482154779136180878e-02,1.023514755070209503e-02,-3.127345070242881775e-02,-1.650564000010490417e-02,-3.136843675747513771e-03,1.611063443124294281e-02,-5.111279338598251343e-02,-2.268875762820243835e-02,1.115740612149238586e-01,-3.343287482857704163e-02,4.031497053802013397e-03,5.864053592085838318e-02,-1.003142818808555603e-02,2.019524760544300079e-02,2.049237862229347229e-02],
                                                        [-7.600148767232894897e-02,2.662717364728450775e-02,3.016666695475578308e-02,-1.567426472902297974e-01,4.905794188380241394e-02,-1.244395389221608639e-03,-3.902187943458557129e-01,-1.981036551296710968e-02,-1.613447815179824829e-02,-1.548487395048141479e-01,-8.749059401452541351e-03,5.015505105257034302e-02,1.295356005430221558e-01,7.164061535149812698e-03,6.171672604978084564e-03,1.696083396673202515e-01,1.793892681598663330e-02,-3.343287482857704163e-02,2.734616994857788086e-01,-3.867644444108009338e-02,-4.708616062998771667e-02,2.052060067653656006e-01,-3.355223685503005981e-02,1.140451617538928986e-02],
                                                        [2.662716619670391083e-02,-2.925664000213146210e-02,-8.546772412955760956e-03,5.383357033133506775e-02,-4.950612410902976990e-02,1.947310636751353741e-03,2.833865117281675339e-03,-9.844948351383209229e-02,6.079970858991146088e-03,2.500935923308134079e-03,-3.971033543348312378e-02,1.838139956817030907e-03,-8.861569687724113464e-03,1.603598520159721375e-02,-2.014619112014770508e-02,-3.615549067035317421e-03,2.019480802118778229e-02,4.031494725495576859e-03,-3.867644444108009338e-02,1.136432588100433350e-01,1.667370833456516266e-02,-3.464198112487792969e-02,6.704854220151901245e-02,-1.877661212347447872e-03],
                                                        [3.016667440533638000e-02,-8.546775206923484802e-03,-3.269629552960395813e-02,1.069469377398490906e-02,-6.969176465645432472e-04,-3.777534142136573792e-02,8.929626084864139557e-03,6.833177991211414337e-03,-9.570439159870147705e-02,5.424158647656440735e-02,4.482368938624858856e-03,-5.198257416486740112e-02,-9.853960946202278137e-03,-2.014618925750255585e-02,1.435151603072881699e-02,-3.453864902257919312e-02,-3.740938380360603333e-03,5.864053592085838318e-02,-4.708616062998771667e-02,1.667370647192001343e-02,1.145691797137260437e-01,-1.255381386727094650e-02,5.141567438840866089e-03,3.059737943112850189e-02],
                                                        [-1.900967359542846680e-01,5.663430690765380859e-02,1.222904026508331299e-02,-1.180685162544250488e-01,2.948104031383991241e-02,-2.969492040574550629e-02,-2.611514329910278320e-01,-1.451526302844285965e-02,-6.871760636568069458e-02,-2.917262017726898193e-01,-7.401697337627410889e-03,-6.550137884914875031e-03,2.035443484783172607e-01,1.666227914392948151e-02,4.531690105795860291e-02,1.380520462989807129e-01,1.670398749411106110e-02,-1.003142539411783218e-02,2.052060067653656006e-01,-3.464197739958763123e-02,-1.255381014198064804e-02,3.142405152320861816e-01,-6.292267888784408569e-02,7.000195980072021484e-02],
                                                        [6.032019481062889099e-02,-6.840075552463531494e-02,-2.128069289028644562e-03,2.948103472590446472e-02,-4.120468348264694214e-02,8.933097124099731445e-03,-2.175522968173027039e-03,-7.400256395339965820e-02,-5.330993735697120428e-05,1.679701730608940125e-02,-6.211435794830322266e-02,-8.497826755046844482e-03,-8.626163937151432037e-03,2.679570391774177551e-02,-4.344525281339883804e-03,6.783559801988303661e-04,1.923118531703948975e-02,2.019524760544300079e-02,-3.355223685503005981e-02,6.704854220151901245e-02,5.141568370163440704e-03,-6.292267888784408569e-02,1.326469480991363525e-01,-1.924617961049079895e-02],
                                                        [2.098203258356079459e-04,2.246927237138152122e-03,-4.945899173617362976e-02,-2.969492599368095398e-02,8.933098986744880676e-03,-4.269202053546905518e-02,-7.272401452064514160e-02,-4.428308922797441483e-03,-9.687640517950057983e-02,-2.903411537408828735e-02,-9.843978099524974823e-03,-6.382266432046890259e-02,4.384255036711692810e-02,4.020850639790296555e-03,6.834189593791961670e-02,5.994203966110944748e-03,2.019525133073329926e-02,2.049238048493862152e-02,1.140451803803443909e-02,-1.877662376500666142e-03,3.059737384319305420e-02,7.000195980072021484e-02,-1.924618147313594818e-02,1.334184259176254272e-01]
                                                        ]),
                                    rtol=1e-9, atol=1e-10)
        
        np.testing.assert_allclose(residuals.flatten(),jnp.array([-1.405297499150037766e-02,
                                                                    -2.810592949390411377e-02,
                                                                    -4.215889051556587219e-02,
                                                                    -1.508405897766351700e-02,
                                                                    -3.016807697713375092e-02,
                                                                    -4.525212571024894714e-02,
                                                                    -1.219632662832736969e-02,
                                                                    -2.439266443252563477e-02,
                                                                    -3.658899292349815369e-02,
                                                                    -1.326222997158765793e-02,
                                                                    -2.652445249259471893e-02,
                                                                    -3.978667035698890686e-02,
                                                                    -2.253364399075508118e-02,
                                                                    -4.506730288267135620e-02,
                                                                    -6.760095804929733276e-02,
                                                                    -2.339273504912853241e-02,
                                                                    -4.678548499941825867e-02,
                                                                    -7.017823308706283569e-02,
                                                                    -1.992567814886569977e-02,
                                                                    -3.985136374831199646e-02,
                                                                    -5.977704375982284546e-02,
                                                                    -2.142298221588134766e-02,
                                                                    -4.284597933292388916e-02,
                                                                    -6.426896154880523682e-02
                                                                    ]),
                                    rtol=1e-9, atol=1e-10)
        
    def test_quad(self):
                
        quad_points_coordinates = jnp.array([[3.00,0.00,0.00],
                                            [2.00,0.75,0.00],
                                            [0.75,1.00,0.00],
                                            [0.00,0.00,0.00]])
        
        fe_mesh = Mesh("",".")
        fe_mesh.node_ids = jnp.arange(len(quad_points_coordinates))
        fe_mesh.nodes_coordinates = quad_points_coordinates
        fe_mesh.elements_nodes = {"quad":fe_mesh.node_ids.reshape(1,-1)}

        mechanical_loss_3d = NeoHookeMechanicalLoss2DQuad("mechanical_loss_2d",
                                                  loss_settings={"dirichlet_bc_dict":{"Ux":{},"Uy":{},"Uz":{}},
                                                                 "material_dict":{"young_modulus":1, "poisson_ratio":0.3},
                                                                 "body_foce":jnp.array([[1],[2]])},
                                                                 fe_mesh=fe_mesh)
        mechanical_loss_3d.Initialize()

        en, residuals, stiffness = mechanical_loss_3d.ComputeElement(quad_points_coordinates,
                                                                     jnp.ones((4)),
                                                                     jnp.ones((8,1)))

        np.testing.assert_allclose(stiffness,jnp.array([[3.825860917568206787e-01,-1.573021858930587769e-01,-2.800459563732147217e-01,-2.706832624971866608e-02,-1.745809167623519897e-01,1.885704100131988525e-01,7.204077392816543579e-02,-4.199907183647155762e-03],
                                                        [-1.573021858930587769e-01,8.645253181457519531e-01,-5.911951512098312378e-02,-1.068440914154052734e+00,1.885704100131988525e-01,-4.166178703308105469e-01,2.785129658877849579e-02,6.205335259437561035e-01],
                                                        [-2.800459563732147217e-01,-5.911951512098312378e-02,7.823255658149719238e-01,3.073264360427856445e-01,-1.540518552064895630e-01,-6.135877687484025955e-03,-3.482277989387512207e-01,-2.420710325241088867e-01],
                                                        [-2.706832997500896454e-02,-1.068440914154052734e+00,3.073264360427856445e-01,1.648686289787292480e+00,-3.818710893392562866e-02,1.336774975061416626e-01,-2.420709878206253052e-01,-7.139228582382202148e-01],
                                                        [-1.745809167623519897e-01,1.885704100131988525e-01,-1.540518552064895630e-01,-3.818712383508682251e-02,5.001542568206787109e-01,-1.396288424730300903e-01,-1.715214997529983521e-01,-1.075444184243679047e-02],
                                                        [1.885704100131988525e-01,-4.166178703308105469e-01,-6.135877687484025955e-03,1.336775124073028564e-01,-1.396288424730300903e-01,1.117690443992614746e+00,-4.280569776892662048e-02,-8.347501754760742188e-01],
                                                        [7.204076647758483887e-02,2.785129286348819733e-02,-3.482277691364288330e-01,-2.420709878206253052e-01,-1.715215146541595459e-01,-4.280569031834602356e-02,4.477085173130035400e-01,2.570253908634185791e-01],
                                                        [-4.199915565550327301e-03,6.205334663391113281e-01,-2.420710325241088867e-01,-7.139228582382202148e-01,-1.075444649904966354e-02,-8.347500562667846680e-01,2.570253908634185791e-01,9.281393885612487793e-01]
                                                        ]),
                                   rtol=1e-6, atol=1e-8)

        np.testing.assert_allclose(residuals.flatten(),jnp.array([-4.947916269302368164e-01,
                                                                    -9.895831942558288574e-01,
                                                                    -3.645833730697631836e-01,
                                                                    -7.291667461395263672e-01,
                                                                    -4.270833134651184082e-01,
                                                                    -8.541666269302368164e-01,
                                                                    -5.572916269302368164e-01,
                                                                    -1.114583253860473633e+00]),
                                   rtol=1e-9, atol=1e-10)


if __name__ == '__main__':
    unittest.main()